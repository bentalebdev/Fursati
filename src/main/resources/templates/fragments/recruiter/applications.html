<!-- Applications Fragment -->
<div th:fragment="applications">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-card-body">
                    <div class="stats-card-icon bg-primary">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stats-card-content">
                        <h5 class="stats-card-title" th:text="${totalDemandes ?: 0}">0</h5>
                        <p class="stats-card-text">Total des candidatures</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-card-body">
                    <div class="stats-card-icon bg-success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stats-card-content">
                        <h5 class="stats-card-title" th:text="${nouveauCount ?: 0}">0</h5>
                        <p class="stats-card-text">Nouvelles candidatures</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-card-body">
                    <div class="stats-card-icon bg-warning">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stats-card-content">
                        <h5 class="stats-card-title" th:text="${enCoursCount ?: 0}">0</h5>
                        <p class="stats-card-text">En cours d'évaluation</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-card-body">
                    <div class="stats-card-icon bg-danger">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stats-card-content">
                        <h5 class="stats-card-title" th:text="${refuseCount ?: 0}">0</h5>
                        <p class="stats-card-text">Refusées</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8 mb-3 mb-md-0">
                    <div class="d-flex flex-wrap gap-2">
                        <select class="form-select form-select-sm" id="offreFilter" name="offreId">
                            <option value="" selected>Toutes les offres</option>
                            <option th:each="offre : ${offres}"
                                    th:value="${offre.id}"
                                    th:text="${offre.title}"
                                    th:selected="${filteredOffreId != null && filteredOffreId == offre.id}">
                                Titre de l'offre
                            </option>
                        </select>
                        <select class="form-select form-select-sm" id="statusFilter" name="status">
                            <option value="" selected>Tous les statuts</option>
                            <option value="PENDING">Nouveau</option>
                            <option value="REVIEWED">En cours d'évaluation</option>
                            <option value="INTERVIEW">Entretien planifié</option>
                            <option value="ACCEPTED">Accepté</option>
                            <option value="REJECTED">Refusé</option>
                        </select>
                        <select class="form-select form-select-sm" id="dateFilter" name="dateRange">
                            <option value="" selected>Toutes les dates</option>
                            <option value="today">Aujourd'hui</option>
                            <option value="week">Cette semaine</option>
                            <option value="month">Ce mois</option>
                            <option value="quarter">Les 3 derniers mois</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" class="form-control form-control-sm" id="searchInput"
                               placeholder="Rechercher un candidat...">
                        <button class="btn btn-sm btn-primary" type="button" id="searchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Applications Table -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                    <tr>
                        <th scope="col" style="width: 40px;">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                            </div>
                        </th>
                        <th scope="col">Candidat</th>
                        <th scope="col">Poste</th>
                        <th scope="col">Date</th>
                        <th scope="col">Correspondance</th>
                        <th scope="col">Statut</th>
                        <th scope="col">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Dynamic rows from database -->
                    <tr th:each="demande : ${demandes}" th:if="${demandes != null && !demandes.isEmpty()}">
                        <td>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" th:value="${demande.idDemande}">
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar me-2">
                                    <span th:text="${#strings.substring(demande.candidat.firstName,0,1) + #strings.substring(demande.candidat.lastName,0,1)}">XY</span>
                                </div>
                                <div>
                                    <h6 class="mb-0" th:text="${demande.candidat.firstName + ' ' + demande.candidat.lastName}">Nom Prénom</h6>
                                    <small class="text-muted" th:text="${demande.candidat.email}">email@example.com</small>
                                </div>
                            </div>
                        </td>
                        <td th:text="${demande.offre.title}">Titre du poste</td>
                        <td th:text="${#dates.format(demande.dateDemande, 'dd MMMM yyyy')}">Date</td>
                        <td>
                            <!-- Calculate match percentage based on skills -->
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar"
                                     th:classappend="${matchPercentages.get(demande.idDemande) >= 70 ? 'bg-success' : (matchPercentages.get(demande.idDemande) >= 50 ? 'bg-warning' : 'bg-danger')}"
                                     th:style="'width: ' + ${matchPercentages.get(demande.idDemande)} + '%'"></div>
                            </div>
                            <small class="text-muted" th:text="${matchPercentages.get(demande.idDemande) + '%'}">0%</small>
                        </td>
                        <td>
                            <span class="badge"
                                  th:classappend="${demande.etat == 'PENDING' ? 'bg-success' :
                                                 (demande.etat == 'REVIEWED' ? 'bg-warning' :
                                                 (demande.etat == 'INTERVIEW' ? 'bg-info' :
                                                 (demande.etat == 'ACCEPTED' ? 'bg-primary' : 'bg-danger')))}"
                                  th:text="${demande.etat == 'PENDING' ? 'Nouveau' : (demande.etat == 'REVIEWED' ? 'En cours d''évaluation' : (demande.etat == 'INTERVIEW' ? 'Entretien planifié' : (demande.etat == 'ACCEPTED' ? 'Accepté' : 'Refusé')))}">
                                Status
                            </span>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    Actions
                                </button>
                                <ul class="dropdown-menu">

                                    <li><a class="dropdown-item" th:href="@{/demandes/{id}(id=${demande.idDemande})}"><i class="fas fa-eye me-2"></i>Voir détails</a></li>
                                    <li><a class="dropdown-item" href="#" th:onclick="'contactCandidat(' + ${demande.candidat.id} + ')'"><i class="fas fa-envelope me-2"></i>Contacter</a></li>

                                    <!-- Conditional menu items based on status -->
                                    <li th:if="${demande.etat != 'INTERVIEW' && demande.etat != 'ACCEPTED' && demande.etat != 'REJECTED'}">
                                        <a class="dropdown-item" href="#" th:onclick="'planifierEntretien(' + ${demande.idDemande} + ')'">
                                            <i class="fas fa-calendar me-2"></i>Planifier entretien
                                        </a>
                                    </li>
                                    <li th:if="${demande.etat == 'INTERVIEW'}">
                                        <a class="dropdown-item" href="#" th:onclick="'modifierEntretien(' + ${demande.idDemande} + ')'">
                                            <i class="fas fa-calendar me-2"></i>Modifier entretien
                                        </a>
                                    </li>
                                    <li th:if="${demande.etat == 'REJECTED'}">
                                        <a class="dropdown-item" href="#" th:onclick="'reexaminer(' + ${demande.idDemande} + ')'">
                                            <i class="fas fa-history me-2"></i>Réexaminer
                                        </a>
                                    </li>
                                    <li th:if="${demande.etat == 'ACCEPTED'}">
                                        <a class="dropdown-item" href="#" th:onclick="'genererContrat(' + ${demande.idDemande} + ')'">
                                            <i class="fas fa-file-contract me-2"></i>Générer contrat
                                        </a>
                                    </li>

                                    <li><hr class="dropdown-divider"></li>

                                    <!-- Accept/Reject options -->
                                    <li th:if="${demande.etat != 'ACCEPTED' && demande.etat != 'REJECTED'}">
                                        <a class="dropdown-item text-success" href="#" th:onclick="'accepter(' + ${demande.idDemande} + ')'">
                                            <i class="fas fa-check me-2"></i>Accepter
                                        </a>
                                    </li>
                                    <li th:if="${demande.etat != 'REJECTED'}">
                                        <a class="dropdown-item text-danger" href="#" th:onclick="'refuser(' + ${demande.idDemande} + ')'">
                                            <i class="fas fa-times me-2"></i>Refuser
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>

                    <!-- Empty state message -->
                    <tr th:if="${demandes == null || demandes.isEmpty()}">
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                            <p>Aucune candidature trouvée</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" id="btnContactBulk"><i class="fas fa-envelope me-1"></i> Contacter</button>
                    <button class="btn btn-sm btn-outline-success me-2" id="btnAcceptBulk"><i class="fas fa-check me-1"></i> Accepter</button>
                    <button class="btn btn-sm btn-outline-danger" id="btnRejectBulk"><i class="fas fa-times me-1"></i> Refuser</button>
                </div>

                <!-- Pagination -->
                <nav th:if="${totalPages > 1}">
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
                            <a class="page-link"
                               th:href="@{/recruteurs/applications(page=${currentPage - 1},size=${pageSize},offreId=${filteredOffreId})}"
                               tabindex="-1" th:aria-disabled="${currentPage == 0}">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                            th:classappend="${currentPage == i ? 'active' : ''}">
                            <a class="page-link"
                               th:href="@{/recruteurs/applications(page=${i},size=${pageSize},offreId=${filteredOffreId})}"
                               th:text="${i + 1}">1</a>
                        </li>
                        <li class="page-item" th:classappend="${currentPage + 1 >= totalPages ? 'disabled' : ''}">
                            <a class="page-link"
                               th:href="@{/recruteurs/applications(page=${currentPage + 1},size=${pageSize},offreId=${filteredOffreId})}">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Modals for different actions -->
    <!-- Contact Modal -->
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactModalLabel">Contacter le candidat</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="contactForm">
                        <input type="hidden" id="contactCandidatId" name="candidatId">
                        <div class="mb-3">
                            <label for="contactSubject" class="form-label">Sujet</label>
                            <input type="text" class="form-control" id="contactSubject" required>
                        </div>
                        <div class="mb-3">
                            <label for="contactMessage" class="form-label">Message</label>
                            <textarea class="form-control" id="contactMessage" rows="5" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="btnSendContact">Envoyer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Interview Scheduling Modal -->
    <div class="modal fade" id="interviewModal" tabindex="-1" aria-labelledby="interviewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="interviewModalLabel">Planifier un entretien</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="interviewForm">
                        <input type="hidden" id="interviewDemandeId" name="demandeId">
                        <input type="hidden" id="interviewIsUpdate" name="isUpdate" value="false">
                        <div class="mb-3">
                            <label for="interviewDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="interviewDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="interviewTime" class="form-label">Heure</label>
                            <input type="time" class="form-control" id="interviewTime" required>
                        </div>
                        <div class="mb-3">
                            <label for="interviewType" class="form-label">Type d'entretien</label>
                            <select class="form-select" id="interviewType" required>
                                <option value="VIDEO">Entretien vidéo</option>
                                <option value="PHONE">Entretien téléphonique</option>
                                <option value="IN_PERSON">Entretien en personne</option>
                                <option value="TECHNICAL">Test technique</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="interviewLocation" class="form-label">Lieu / Lien</label>
                            <input type="text" class="form-control" id="interviewLocation">
                        </div>
                        <div class="mb-3">
                            <label for="interviewNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="interviewNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="btnSaveInterview">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rejection Reason Modal -->
    <div class="modal fade" id="rejectionModal" tabindex="-1" aria-labelledby="rejectionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectionModalLabel">Motif de refus</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="rejectionForm">
                        <input type="hidden" id="rejectionDemandeId" name="demandeId">
                        <div class="mb-3">
                            <label for="rejectionReason" class="form-label">Motif de refus</label>
                            <select class="form-select" id="rejectionReason" required>
                                <option value="" selected disabled>Sélectionnez un motif</option>
                                <option value="INSUFFICIENT_EXPERIENCE">Expérience insuffisante</option>
                                <option value="SKILLS_MISMATCH">Compétences ne correspondent pas</option>
                                <option value="EDUCATION_MISMATCH">Formation ne correspond pas</option>
                                <option value="BETTER_CANDIDATE">Candidat(e) plus qualifié(e) sélectionné(e)</option>
                                <option value="POSITION_FILLED">Poste pourvu</option>
                                <option value="POSITION_CANCELLED">Poste annulé</option>
                                <option value="OTHER">Autre raison</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="rejectionComment" class="form-label">Commentaire</label>
                            <textarea class="form-control" id="rejectionComment" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Envoyer un email de refus</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendRejectionEmail" checked>
                                <label class="form-check-label" for="sendRejectionEmail">
                                    Envoyer un email automatique au candidat
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmReject">Rejeter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Contact Modal -->
    <div class="modal fade" id="bulkContactModal" tabindex="-1" aria-labelledby="bulkContactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkContactModalLabel">Contacter les candidats</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="bulkContactForm">
                        <input type="hidden" id="bulkContactIds" name="demandeIds">
                        <div class="mb-3">
                            <label for="bulkContactSubject" class="form-label">Sujet</label>
                            <input type="text" class="form-control" id="bulkContactSubject" required>
                        </div>
                        <div class="mb-3">
                            <label for="bulkContactMessage" class="form-label">Message</label>
                            <textarea class="form-control" id="bulkContactMessage" rows="5" required></textarea>
                            <small class="text-muted">Variables disponibles: {nom}, {prenom}, {poste}</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="btnSendBulkContact">Envoyer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Rejection Modal -->
    <div class="modal fade" id="bulkRejectionModal" tabindex="-1" aria-labelledby="bulkRejectionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkRejectionModalLabel">Refuser plusieurs candidatures</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="bulkRejectionForm">
                        <input type="hidden" id="bulkRejectionIds" name="demandeIds">
                        <div class="mb-3">
                            <label for="bulkRejectionReason" class="form-label">Motif de refus</label>
                            <select class="form-select" id="bulkRejectionReason" required>
                                <option value="" selected disabled>Sélectionnez un motif</option>
                                <option value="INSUFFICIENT_EXPERIENCE">Expérience insuffisante</option>
                                <option value="SKILLS_MISMATCH">Compétences ne correspondent pas</option>
                                <option value="BETTER_CANDIDATE">Candidat(e) plus qualifié(e) sélectionné(e)</option>
                                <option value="POSITION_FILLED">Poste pourvu</option>
                                <option value="POSITION_CANCELLED">Poste annulé</option>
                                <option value="OTHER">Autre raison</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="bulkRejectionComment" class="form-label">Commentaire</label>
                            <textarea class="form-control" id="bulkRejectionComment" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Envoyer un email de refus</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="bulkSendRejectionEmail" checked>
                                <label class="form-check-label" for="bulkSendRejectionEmail">
                                    Envoyer un email automatique aux candidats
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmBulkReject">Rejeter tout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for actions -->
    <script>
        // Action functions
        function contactCandidat(candidatId) {
            console.log('Contact candidat:', candidatId);
            // Implement contact functionality

            // Show modal with contact form
            const contactModal = new bootstrap.Modal(document.getElementById('contactModal'));
            document.getElementById('contactCandidatId').value = candidatId;
            contactModal.show();
        }

        function planifierEntretien(demandeId) {
            console.log('Planifier entretien pour demande:', demandeId);
            // Show interview scheduling modal
            const interviewModal = new bootstrap.Modal(document.getElementById('interviewModal'));
            document.getElementById('interviewDemandeId').value = demandeId;
            interviewModal.show();
        }

        function modifierEntretien(demandeId) {
            console.log('Modifier entretien pour demande:', demandeId);
            // Fetch current interview data first
            fetch(`/demandes/${demandeId}/interview`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Pre-fill the interview form
                        document.getElementById('interviewDate').value = data.date;
                        document.getElementById('interviewTime').value = data.time;
                        document.getElementById('interviewType').value = data.type;
                        document.getElementById('interviewNotes').value = data.notes;

                        // Show the modal
                        const interviewModal = new bootstrap.Modal(document.getElementById('interviewModal'));
                        document.getElementById('interviewDemandeId').value = demandeId;
                        document.getElementById('interviewIsUpdate').value = true;
                        interviewModal.show();
                    }
                });
        }

        function reexaminer(demandeId) {
            console.log('Réexaminer demande:', demandeId);

            if (confirm('Êtes-vous sûr de vouloir réexaminer cette candidature?')) {
                // Example AJAX call
                fetch(`/demandes/${demandeId}/reexamine`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Refresh the page to show updated status
                            window.location.reload();
                        } else {
                            alert('Erreur: ' + data.error);
                        }
                    });
            }
        }

        function genererContrat(demandeId) {
            console.log('Générer contrat pour demande:', demandeId);
            window.location.href = `/recruteurs/generer-contrat/${demandeId}`;
        }

        function accepter(demandeId) {
            console.log('Accepter demande:', demandeId);

            if (confirm('Êtes-vous sûr de vouloir accepter cette candidature?')) {
                // Example AJAX call
                fetch(`/demandes/${demandeId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: 'ACCEPTED'
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Refresh the page to show updated status
                            window.location.reload();
                        } else {
                            alert('Erreur: ' + data.error);
                        }
                    });
            }
        }

        function refuser(demandeId) {
            console.log('Refuser demande:', demandeId);

            // Show rejection reason modal
            const rejectionModal = new bootstrap.Modal(document.getElementById('rejectionModal'));
            document.getElementById('rejectionDemandeId').value = demandeId;
            rejectionModal.show();
        }

        // Filter handling
        document.addEventListener('DOMContentLoaded', function() {
            // Offer filter change event
            const offreFilter = document.getElementById('offreFilter');
            if (offreFilter) {
                offreFilter.addEventListener('change', function() {
                    window.location.href = `/recruteurs/applications?offreId=${this.value}`;
                });
            }

            // Status filter change event
            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    // Get current URL params
                    const urlParams = new URLSearchParams(window.location.search);
                    urlParams.set('status', this.value);
                    window.location.href = `/recruteurs/applications?${urlParams.toString()}`;
                });
            }

            // Date filter change event
            const dateFilter = document.getElementById('dateFilter');
            if (dateFilter) {
                dateFilter.addEventListener('change', function() {
                    // Get current URL params
                    const urlParams = new URLSearchParams(window.location.search);
                    urlParams.set('dateRange', this.value);
                    window.location.href = `/recruteurs/applications?${urlParams.toString()}`;
                });
            }

            // Select all checkbox
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('tbody .form-check-input');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                    updateBulkActionButtonsState();
                });
            }

            // Individual checkboxes change event
            const individualCheckboxes = document.querySelectorAll('tbody .form-check-input');
            if (individualCheckboxes) {
                individualCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        updateBulkActionButtonsState();
                    });
                });
            }

            // Update bulk action buttons state based on checkbox selection
            function updateBulkActionButtonsState() {
                const checkedCount = document.querySelectorAll('tbody .form-check-input:checked').length;
                const bulkButtons = document.querySelectorAll('#btnContactBulk, #btnAcceptBulk, #btnRejectBulk');

                bulkButtons.forEach(button => {
                    if (checkedCount > 0) {
                        button.removeAttribute('disabled');
                    } else {
                        button.setAttribute('disabled', 'disabled');
                    }
                });
            }

            // Initialize bulk action buttons state
            updateBulkActionButtonsState();

            // Bulk action buttons event listeners
            const btnContactBulk = document.getElementById('btnContactBulk');
            if (btnContactBulk) {
                btnContactBulk.addEventListener('click', function() {
                    const selectedIds = getSelectedDemandeIds();
                    if (selectedIds.length > 0) {
                        console.log('Contact en masse pour les demandes:', selectedIds);
                        // Show bulk contact modal
                        const bulkContactModal = new bootstrap.Modal(document.getElementById('bulkContactModal'));
                        document.getElementById('bulkContactIds').value = selectedIds.join(',');
                        bulkContactModal.show();
                    }
                });
            }

            const btnAcceptBulk = document.getElementById('btnAcceptBulk');
            if (btnAcceptBulk) {
                btnAcceptBulk.addEventListener('click', function() {
                    const selectedIds = getSelectedDemandeIds();
                    if (selectedIds.length > 0 && confirm(`Êtes-vous sûr de vouloir accepter ${selectedIds.length} candidature(s)?`)) {
                        console.log('Acceptation en masse pour les demandes:', selectedIds);

                        // Example AJAX call for bulk accept
                        fetch(`/demandes/bulk-status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                ids: selectedIds,
                                status: 'ACCEPTED'
                            })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Refresh the page to show updated statuses
                                    window.location.reload();
                                } else {
                                    alert('Erreur: ' + data.error);
                                }
                            });
                    }
                });
            }

            const btnRejectBulk = document.getElementById('btnRejectBulk');
            if (btnRejectBulk) {
                btnRejectBulk.addEventListener('click', function() {
                    const selectedIds = getSelectedDemandeIds();
                    if (selectedIds.length > 0) {
                        console.log('Refus en masse pour les demandes:', selectedIds);
                        // Show bulk rejection reason modal
                        const bulkRejectionModal = new bootstrap.Modal(document.getElementById('bulkRejectionModal'));
                        document.getElementById('bulkRejectionIds').value = selectedIds.join(',');
                        bulkRejectionModal.show();
                    }
                });
            }

            // Helper function to get selected demande IDs
            function getSelectedDemandeIds() {
                const checkboxes = document.querySelectorAll('tbody .form-check-input:checked');
                return Array.from(checkboxes).map(checkbox => checkbox.value);
            }

            // Search functionality
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');
            if (searchBtn && searchInput) {
                searchBtn.addEventListener('click', function() {
                    const searchTerm = searchInput.value.trim();
                    if (searchTerm) {
                        // Get current URL params
                        const urlParams = new URLSearchParams(window.location.search);
                        urlParams.set('keyword', searchTerm);
                        window.location.href = `/recruteurs/applications?${urlParams.toString()}`;
                    }
                });

                // Also trigger search on Enter key
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchBtn.click();
                    }
                });
            }

            // Modal buttons event listeners
            const btnSendContact = document.getElementById('btnSendContact');
            if (btnSendContact) {
                btnSendContact.addEventListener('click', function() {
                    const candidatId = document.getElementById('contactCandidatId').value;
                    const subject = document.getElementById('contactSubject').value;
                    const message = document.getElementById('contactMessage').value;

                    if (!subject || !message) {
                        alert('Veuillez remplir tous les champs obligatoires.');
                        return;
                    }

                    // Send contact message
                    fetch('/candidats/contact', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            candidatId: candidatId,
                            subject: subject,
                            message: message
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const modal = bootstrap.Modal.getInstance(document.getElementById('contactModal'));
                                modal.hide();
                                alert('Message envoyé avec succès.');

                                // Reset form
                                document.getElementById('contactForm').reset();
                            } else {
                                alert('Erreur: ' + data.error);
                            }
                        });
                });
            }

            // Interview form submission
            const btnSaveInterview = document.getElementById('btnSaveInterview');
            if (btnSaveInterview) {
                btnSaveInterview.addEventListener('click', function() {
                    const demandeId = document.getElementById('interviewDemandeId').value;
                    const isUpdate = document.getElementById('interviewIsUpdate').value === 'true';
                    const date = document.getElementById('interviewDate').value;
                    const time = document.getElementById('interviewTime').value;
                    const type = document.getElementById('interviewType').value;
                    const location = document.getElementById('interviewLocation').value;
                    const notes = document.getElementById('interviewNotes').value;

                    if (!date || !time || !type) {
                        alert('Veuillez remplir tous les champs obligatoires.');
                        return;
                    }

                    // Save interview
                    fetch(`/demandes/${demandeId}/interview`, {
                        method: isUpdate ? 'PUT' : 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            date: date,
                            time: time,
                            type: type,
                            location: location,
                            notes: notes
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const modal = bootstrap.Modal.getInstance(document.getElementById('interviewModal'));
                                modal.hide();
                                alert(isUpdate ? 'Entretien modifié avec succès.' : 'Entretien planifié avec succès.');

                                // Reset form
                                document.getElementById('interviewForm').reset();

                                // Reload page
                                window.location.reload();
                            } else {
                                alert('Erreur: ' + data.error);
                            }
                        });
                });
            }

            // Rejection form submission
            const btnConfirmReject = document.getElementById('btnConfirmReject');
            if (btnConfirmReject) {
                btnConfirmReject.addEventListener('click', function() {
                    const demandeId = document.getElementById('rejectionDemandeId').value;
                    const reason = document.getElementById('rejectionReason').value;
                    const comment = document.getElementById('rejectionComment').value;
                    const sendEmail = document.getElementById('sendRejectionEmail').checked;

                    if (!reason) {
                        alert('Veuillez sélectionner un motif de refus.');
                        return;
                    }

                    // Reject application
                    fetch(`/demandes/${demandeId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            status: 'REJECTED',
                            reason: reason,
                            comment: comment,
                            sendEmail: sendEmail
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const modal = bootstrap.Modal.getInstance(document.getElementById('rejectionModal'));
                                modal.hide();
                                alert('Candidature refusée avec succès.');

                                // Reset form
                                document.getElementById('rejectionForm').reset();

                                // Reload page
                                window.location.reload();
                            } else {
                                alert('Erreur: ' + data.error);
                            }
                        });
                });
            }

            // Bulk contact form submission
            const btnSendBulkContact = document.getElementById('btnSendBulkContact');
            if (btnSendBulkContact) {
                btnSendBulkContact.addEventListener('click', function() {
                    const demandeIds = document.getElementById('bulkContactIds').value.split(',');
                    const subject = document.getElementById('bulkContactSubject').value;
                    const message = document.getElementById('bulkContactMessage').value;

                    if (!subject || !message) {
                        alert('Veuillez remplir tous les champs obligatoires.');
                        return;
                    }

                    // Send bulk contact message
                    fetch('/candidats/bulk-contact', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            demandeIds: demandeIds,
                            subject: subject,
                            message: message
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const modal = bootstrap.Modal.getInstance(document.getElementById('bulkContactModal'));
                                modal.hide();
                                alert(`Messages envoyés avec succès à ${demandeIds.length} candidat(s).`);

                                // Reset form
                                document.getElementById('bulkContactForm').reset();
                            } else {
                                alert('Erreur: ' + data.error);
                            }
                        });
                });
            }

            // Bulk rejection form submission
            const btnConfirmBulkReject = document.getElementById('btnConfirmBulkReject');
            if (btnConfirmBulkReject) {
                btnConfirmBulkReject.addEventListener('click', function() {
                    const demandeIds = document.getElementById('bulkRejectionIds').value.split(',');
                    const reason = document.getElementById('bulkRejectionReason').value;
                    const comment = document.getElementById('bulkRejectionComment').value;
                    const sendEmail = document.getElementById('bulkSendRejectionEmail').checked;

                    if (!reason) {
                        alert('Veuillez sélectionner un motif de refus.');
                        return;
                    }

                    // Reject bulk applications
                    fetch('/demandes/bulk-status', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ids: demandeIds,
                            status: 'REJECTED',
                            reason: reason,
                            comment: comment,
                            sendEmail: sendEmail
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const modal = bootstrap.Modal.getInstance(document.getElementById('bulkRejectionModal'));
                                modal.hide();
                                alert(`${demandeIds.length} candidature(s) refusée(s) avec succès.`);

                                // Reset form
                                document.getElementById('bulkRejectionForm').reset();

                                // Reload page
                                window.location.reload();
                            } else {
                                alert('Erreur: ' + data.error);
                            }
                        });
                });
            }
        });
    </script>

    <style>
        /* Styles for applications page */
        .stats-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stats-card-body {
            padding: 20px;
            display: flex;
            align-items: center;
        }

        .stats-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
        }

        .stats-card-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 0;
            line-height: 1.2;
        }

        .stats-card-text {
            color: #6c757d;
            margin-bottom: 0;
            font-size: 14px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            background-color: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #495057;
        }

        .form-check-input:checked {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
        }

        /* Table row hover effect */
        .table tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }

        /* Badge styles */
        .badge {
            font-size: 0.75rem;
            padding: 0.35em 0.65em;
            font-weight: 500;
        }

        /* Progress bar animation */
        .progress-bar {
            transition: width 0.6s ease;
        }

        /* Page buttons hover effect */
        .pagination .page-link:hover {
            background-color: #e9ecef;
            border-color: #dee2e6;
            color: #0d6efd;
        }

        /* Buttons states */
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.65;
        }
    </style>
</div>