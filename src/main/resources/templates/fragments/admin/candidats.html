<div th:fragment="candidats" xmlns:th="http://www.thymeleaf.org">
  <div class="app-card mb-4">
    <div class="app-card-header">
      <h5 class="app-card-title">Filtres</h5>
    </div>
    <div class="app-card-body">
      <form id="candidatFilterForm" method="get" action="/admin/candidats">
        <div class="row">
          <div class="col-md-3 mb-3">
            <label class="form-label">Statut</label>
            <select class="form-select" name="status" id="status">
              <option value="">Tous les statuts</option>
              <option value="active">Actif</option>
              <option value="pending">En attente</option>
              <option value="blocked">Bloqué</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Compétences</label>
            <select class="form-select" name="skill" id="skill">
              <option value="">Toutes les compétences</option>
              <option th:each="skill : ${allSkills}" th:value="${skill}" th:text="${skill}">Compétence</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Ville</label>
            <select class="form-select" name="city" id="city">
              <option value="">Toutes les villes</option>
              <option th:each="city : ${cities}" th:value="${city}" th:text="${city}">Ville</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">Âge</label>
            <select class="form-select" name="ageRange" id="ageRange">
              <option value="">Tous les âges</option>
              <option value="18-25">18-25 ans</option>
              <option value="26-35">26-35 ans</option>
              <option value="36-45">36-45 ans</option>
              <option value="46+">46+ ans</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Recherche</label>
            <input type="text" class="form-control" name="search" id="search" placeholder="Nom, email, téléphone...">
          </div>
          <div class="col-md-6 d-flex align-items-end justify-content-end mb-3">
            <button type="submit" class="btn btn-primary me-2">Appliquer les filtres</button>
            <button type="reset" class="btn btn-outline-secondary" id="resetFilters">Réinitialiser</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="app-card">
    <div class="app-card-header">
      <h5 class="app-card-title">Candidats</h5>
      <div>
        <button class="btn btn-sm btn-success me-2" data-bs-toggle="modal" data-bs-target="#addCandidatModal">
          <i class="fas fa-plus me-1"></i> Ajouter
        </button>
        <button class="btn btn-sm btn-outline-secondary me-2" id="exportCandidats">
          <i class="fas fa-download me-1"></i> Exporter
        </button>
        <button class="btn btn-sm btn-outline-danger" id="deleteSelectedCandidats" disabled>
          <i class="fas fa-trash me-1"></i> Supprimer
        </button>
      </div>
    </div>
    <div class="app-card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
          <tr>
            <th width="40">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="selectAll">
              </div>
            </th>
            <th>Nom</th>
            <th>Email</th>
            <th>Téléphone</th>
            <th>Adresse</th>
            <th>Date de naissance</th>
            <th>Compétences</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody>
          <!-- Loop through candidates using Thymeleaf -->
          <tr th:each="candidat : ${candidats}">
            <td>
              <div class="form-check">
                <input class="form-check-input candidat-checkbox" type="checkbox" th:value="${candidat.id}">
              </div>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <!-- Show profile picture if available, otherwise use initials -->
                <div th:if="${candidat.profilePicture != null && !candidat.profilePicture.isEmpty()}" class="me-2">
                  <img th:src="${candidat.profilePicture}" alt="Profile" width="32" height="32" class="rounded-circle">
                </div>
                <div th:unless="${candidat.profilePicture != null && !candidat.profilePicture.isEmpty()}"
                     class="avatar avatar-sm me-2 bg-primary rounded"
                     th:text="${#strings.substring(candidat.firstName, 0, 1) + #strings.substring(candidat.lastName, 0, 1)}">
                </div>
                <div th:text="${candidat.firstName + ' ' + candidat.lastName}">Nom Complet</div>
              </div>
            </td>
            <td th:text="${candidat.email}">email@example.com</td>
            <td th:text="${candidat.phone}">Téléphone</td>
            <td th:text="${candidat.address}">Adresse</td>
            <td th:text="${#temporals.format(candidat.birthdate, 'dd/MM/yyyy')}">Date de naissance</td>
            <td>
              <!-- Show first 2 skills if available -->
              <div th:if="${!candidat.skills.empty}">
                <span class="badge bg-light text-dark me-1" th:each="skill, status : ${candidat.skills}" th:if="${status.index < 2}" th:text="${skill.name}">Compétence</span>
                <small th:if="${candidat.skills.size() > 2}" th:text="'+ ' + (${candidat.skills.size() - 2})"></small>
              </div>
              <span th:if="${candidat.skills.empty}" class="text-muted">Aucune compétence</span>
            </td>
            <td>
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  Actions
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" th:href="@{/admin/candidats/details/{id}(id=${candidat.id})}">Voir détails</a></li>
                  <li><a class="dropdown-item edit-candidat" href="#" th:data-id="${candidat.id}">Modifier</a></li>
                  <li><a class="dropdown-item toggle-status" href="#" th:data-id="${candidat.id}">Changer statut</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger delete-candidat" href="#" th:data-id="${candidat.id}">Supprimer</a></li>
                </ul>
              </div>
            </td>
          </tr>
          <!-- Empty state message when no candidates are found -->
          <tr th:if="${candidats.empty}">
            <td colspan="8" class="text-center py-4">
              <div class="text-muted">Aucun candidat n'a été trouvé</div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="app-card-footer p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>Affichage de <span th:text="${candidats.size() > 0 ? 1 : 0}"></span> à <span th:text="${candidats.size()}"></span> sur <span th:text="${totalCandidats != null ? totalCandidats : candidats.size()}"></span> entrées</div>
        <!-- Pagination -->
        <nav th:if="${totalPages != null && totalPages > 1}">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled' : ''">
              <a class="page-link" th:href="@{/admin/candidats(page=${currentPage - 1}, size=${pageSize}, search=${search}, status=${status}, skill=${skill}, city=${city}, ageRange=${ageRange})}">Précédent</a>
            </li>
            <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}" th:classappend="${currentPage == i} ? 'active' : ''">
              <a class="page-link" th:href="@{/admin/candidats(page=${i}, size=${pageSize}, search=${search}, status=${status}, skill=${skill}, city=${city}, ageRange=${ageRange})}" th:text="${i + 1}"></a>
            </li>
            <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled' : ''">
              <a class="page-link" th:href="@{/admin/candidats(page=${currentPage + 1}, size=${pageSize}, search=${search}, status=${status}, skill=${skill}, city=${city}, ageRange=${ageRange})}">Suivant</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- Add Candidat Modal -->
  <div class="modal fade" id="addCandidatModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ajouter un candidat</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addCandidatForm" class="needs-validation" novalidate>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="addFirstName" class="form-label">Prénom*</label>
                <input type="text" class="form-control" id="addFirstName" name="firstName" required>
                <div class="invalid-feedback">Veuillez saisir le prénom</div>
              </div>
              <div class="col-md-6">
                <label for="addLastName" class="form-label">Nom*</label>
                <input type="text" class="form-control" id="addLastName" name="lastName" required>
                <div class="invalid-feedback">Veuillez saisir le nom</div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="addEmail" class="form-label">Email*</label>
                <input type="email" class="form-control" id="addEmail" name="email" required>
                <div class="invalid-feedback">Veuillez saisir une adresse email valide</div>
              </div>
              <div class="col-md-6">
                <label for="addPhone" class="form-label">Téléphone*</label>
                <input type="tel" class="form-control" id="addPhone" name="phone" required>
                <div class="invalid-feedback">Veuillez saisir un numéro de téléphone</div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="addBirthdate" class="form-label">Date de naissance</label>
                <input type="date" class="form-control" id="addBirthdate" name="birthdate">
              </div>
              <div class="col-md-6">
                <label for="addAddress" class="form-label">Adresse</label>
                <input type="text" class="form-control" id="addAddress" name="address">
              </div>
            </div>
            <div class="mb-3">
              <label for="addSummary" class="form-label">Résumé professionnel</label>
              <textarea class="form-control" id="addSummary" name="summary" rows="3"></textarea>
            </div>

            <!-- Skills section -->
            <h6 class="mt-4 mb-3">Compétences</h6>
            <div id="skillsContainer">
              <div class="row mb-2 skill-row">
                <div class="col-md-5">
                  <input type="text" class="form-control" name="skills[0].name" placeholder="Nom de la compétence">
                </div>
                <div class="col-md-5">
                  <select class="form-select" name="skills[0].proficiency">
                    <option value="">Niveau de maîtrise</option>
                    <option value="Débutant">Débutant</option>
                    <option value="Intermédiaire">Intermédiaire</option>
                    <option value="Avancé">Avancé</option>
                    <option value="Expert">Expert</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <button type="button" class="btn btn-outline-danger remove-skill d-none">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="addSkillBtn">
              <i class="fas fa-plus"></i> Ajouter une compétence
            </button>

            <!-- Languages section -->
            <h6 class="mt-4 mb-3">Langues</h6>
            <div id="languagesContainer">
              <div class="row mb-2 language-row">
                <div class="col-md-5">
                  <input type="text" class="form-control" name="languages[0].name" placeholder="Nom de la langue">
                </div>
                <div class="col-md-5">
                  <select class="form-select" name="languages[0].proficiency">
                    <option value="">Niveau de maîtrise</option>
                    <option value="Débutant">Débutant</option>
                    <option value="Intermédiaire">Intermédiaire</option>
                    <option value="Avancé">Avancé</option>
                    <option value="Bilingue">Bilingue</option>
                    <option value="Langue maternelle">Langue maternelle</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <button type="button" class="btn btn-outline-danger remove-language d-none">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="addLanguageBtn">
              <i class="fas fa-plus"></i> Ajouter une langue
            </button>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="addCandidatSubmit">Ajouter</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Candidat Modal -->
  <div class="modal fade" id="editCandidatModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Modifier le candidat</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editCandidatForm" class="needs-validation" novalidate>
            <input type="hidden" id="editCandidatId" name="id">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="editFirstName" class="form-label">Prénom*</label>
                <input type="text" class="form-control" id="editFirstName" name="firstName" required>
                <div class="invalid-feedback">Veuillez saisir le prénom</div>
              </div>
              <div class="col-md-6">
                <label for="editLastName" class="form-label">Nom*</label>
                <input type="text" class="form-control" id="editLastName" name="lastName" required>
                <div class="invalid-feedback">Veuillez saisir le nom</div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="editEmail" class="form-label">Email*</label>
                <input type="email" class="form-control" id="editEmail" name="email" required>
                <div class="invalid-feedback">Veuillez saisir une adresse email valide</div>
              </div>
              <div class="col-md-6">
                <label for="editPhone" class="form-label">Téléphone*</label>
                <input type="tel" class="form-control" id="editPhone" name="phone" required>
                <div class="invalid-feedback">Veuillez saisir un numéro de téléphone</div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="editBirthdate" class="form-label">Date de naissance</label>
                <input type="date" class="form-control" id="editBirthdate" name="birthdate">
              </div>
              <div class="col-md-6">
                <label for="editAddress" class="form-label">Adresse</label>
                <input type="text" class="form-control" id="editAddress" name="address">
              </div>
            </div>
            <div class="mb-3">
              <label for="editSummary" class="form-label">Résumé professionnel</label>
              <textarea class="form-control" id="editSummary" name="summary" rows="3"></textarea>
            </div>

            <!-- Skills section -->
            <h6 class="mt-4 mb-3">Compétences</h6>
            <div id="editSkillsContainer">
              <!-- Skills will be dynamically added here -->
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="editAddSkillBtn">
              <i class="fas fa-plus"></i> Ajouter une compétence
            </button>

            <!-- Languages section -->
            <h6 class="mt-4 mb-3">Langues</h6>
            <div id="editLanguagesContainer">
              <!-- Languages will be dynamically added here -->
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="editAddLanguageBtn">
              <i class="fas fa-plus"></i> Ajouter une langue
            </button>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="editCandidatSubmit">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteCandidatModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmation de suppression</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Êtes-vous sûr de vouloir supprimer ce candidat ? Cette action est irréversible.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-danger" id="confirmDelete">Supprimer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Batch Delete Confirmation Modal -->
  <div class="modal fade" id="batchDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmation de suppression multiple</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Êtes-vous sûr de vouloir supprimer <span id="selectedCount">0</span> candidats ? Cette action est irréversible.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-danger" id="confirmBatchDelete">Supprimer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Change Modal -->
  <div class="modal fade" id="statusChangeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Changer le statut</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="statusChangeForm">
            <input type="hidden" id="statusCandidatId" name="id">
            <div class="mb-3">
              <label for="statusSelect" class="form-label">Nouveau statut</label>
              <select class="form-select" id="statusSelect" name="status" required>
                <option value="active">Actif</option>
                <option value="pending">En attente</option>
                <option value="blocked">Bloqué</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="confirmStatusChange">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript to handle client-side interactions -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Selectors
      const selectAllCheckbox = document.getElementById('selectAll');
      const candidatCheckboxes = document.querySelectorAll('.candidat-checkbox');
      const deleteSelectedBtn = document.getElementById('deleteSelectedCandidats');

      // Filter form
      const filterForm = document.getElementById('candidatFilterForm');
      const resetButton = document.getElementById('resetFilters');

      // Export button
      const exportBtn = document.getElementById('exportCandidats');

      // Modals
      const deleteCandidatModal = new bootstrap.Modal(document.getElementById('deleteCandidatModal'));
      const batchDeleteModal = new bootstrap.Modal(document.getElementById('batchDeleteModal'));
      const addCandidatModal = new bootstrap.Modal(document.getElementById('addCandidatModal'));
      const editCandidatModal = new bootstrap.Modal(document.getElementById('editCandidatModal'));
      const statusChangeModal = new bootstrap.Modal(document.getElementById('statusChangeModal'));

      // Initialize with current filter values from URL
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('status')) {
        document.getElementById('status').value = urlParams.get('status');
      }
      if (urlParams.has('skill')) {
        document.getElementById('skill').value = urlParams.get('skill');
      }
      if (urlParams.has('city')) {
        document.getElementById('city').value = urlParams.get('city');
      }
      if (urlParams.has('ageRange')) {
        document.getElementById('ageRange').value = urlParams.get('ageRange');
      }
      if (urlParams.has('search')) {
        document.getElementById('search').value = urlParams.get('search');
      }

      // Select all candidats
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
          candidatCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
          });
          updateDeleteButtonState();
        });
      }

      // Update delete button state
      candidatCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateDeleteButtonState);
      });

      function updateDeleteButtonState() {
        const checkedBoxes = document.querySelectorAll('.candidat-checkbox:checked');
        if (deleteSelectedBtn) {
          deleteSelectedBtn.disabled = checkedBoxes.length === 0;
        }

        // Update the count for the batch delete modal
        const selectedCountElement = document.getElementById('selectedCount');
        if (selectedCountElement) {
          selectedCountElement.textContent = checkedBoxes.length;
        }
      }

      // Reset filters
      if (resetButton) {
        resetButton.addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('status').value = '';
          document.getElementById('skill').value = '';
          document.getElementById('city').value = '';
          document.getElementById('ageRange').value = '';
          document.getElementById('search').value = '';
          filterForm.submit();
        });
      }

      // Delete single candidat
      let candidatToDelete = null;
      const deleteButtons = document.querySelectorAll('.delete-candidat');

      deleteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          candidatToDelete = this.getAttribute('data-id');
          deleteCandidatModal.show();
        });
      });

      // Confirm delete
      const confirmDeleteButton = document.getElementById('confirmDelete');
      if (confirmDeleteButton) {
        confirmDeleteButton.addEventListener('click', function() {
          if (candidatToDelete) {
            fetch(`/admin/candidats/delete/${candidatToDelete}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              }
            })
                    .then(response => response.json())
                    .then(data => {
                      if (data.success) {
                        window.location.reload();
                      } else {
                        alert('Erreur lors de la suppression: ' + data.error);
                      }
                    })
                    .catch(error => {
                      console.error('Error:', error);
                      alert('Une erreur est survenue lors de la suppression');
                    });

            deleteCandidatModal.hide();
          }
        });
      }

      // Delete multiple candidats
      if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', function() {
          const selectedIds = Array.from(document.querySelectorAll('.candidat-checkbox:checked'))
                  .map(checkbox => checkbox.value);

          if (selectedIds.length > 0) {
            batchDeleteModal.show();
          }
        });
      }

      const confirmBatchDeleteButton = document.getElementById('confirmBatchDelete');
      if (confirmBatchDeleteButton) {
        confirmBatchDeleteButton.addEventListener('click', function() {
          const selectedIds = Array.from(document.querySelectorAll('.candidat-checkbox:checked'))
                  .map(checkbox => checkbox.value);

          fetch('/admin/candidats/batch-delete', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ids: selectedIds })
          })
                  .then(response => response.json())
                  .then(data => {
                    if (data.success) {
                      window.location.reload();
                    } else {
                      alert('Erreur lors de la suppression multiple: ' + data.error);
                    }
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    alert('Une erreur est survenue lors de la suppression multiple');
                  });

          batchDeleteModal.hide();
        });
      }

      // Add candidat form
      const addCandidatForm = document.getElementById('addCandidatForm');
      const addCandidatSubmit = document.getElementById('addCandidatSubmit');

      // Add skill button
      const addSkillBtn = document.getElementById('addSkillBtn');
      if (addSkillBtn) {
        addSkillBtn.addEventListener('click', function() {
          const skillsContainer = document.getElementById('skillsContainer');
          const skillCount = skillsContainer.querySelectorAll('.skill-row').length;

          const newSkillRow = document.createElement('div');
          newSkillRow.className = 'row mb-2 skill-row';
          newSkillRow.innerHTML = `
            <div class="col-md-5">
              <input type="text" class="form-control" name="skills[${skillCount}].name" placeholder="Nom de la compétence">
            </div>
            <div class="col-md-5">
              <select class="form-select" name="skills[${skillCount}].proficiency">
                <option value="">Niveau de maîtrise</option>
                <option value="Débutant">Débutant</option>
                <option value="Intermédiaire">Intermédiaire</option>
                <option value="Avancé">Avancé</option>
                <option value="Expert">Expert</option>
              </select>
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-outline-danger remove-skill">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;

          skillsContainer.appendChild(newSkillRow);

          // Activer le bouton de suppression
          if (skillsContainer.querySelectorAll('.skill-row').length > 1) {
            skillsContainer.querySelectorAll('.remove-skill').forEach(btn => {
              btn.classList.remove('d-none');
            });
          }

          // Ajouter l'écouteur d'événement pour la suppression
          newSkillRow.querySelector('.remove-skill').addEventListener('click', function() {
            newSkillRow.remove();
            reindexSkills();

            // Masquer le bouton de suppression s'il ne reste qu'une compétence
            if (skillsContainer.querySelectorAll('.skill-row').length <= 1) {
              skillsContainer.querySelector('.remove-skill').classList.add('d-none');
            }
          });
        });
      }

      // Add language button
      const addLanguageBtn = document.getElementById('addLanguageBtn');
      if (addLanguageBtn) {
        addLanguageBtn.addEventListener('click', function() {
          const languagesContainer = document.getElementById('languagesContainer');
          const languageCount = languagesContainer.querySelectorAll('.language-row').length;

          const newLanguageRow = document.createElement('div');
          newLanguageRow.className = 'row mb-2 language-row';
          newLanguageRow.innerHTML = `
            <div class="col-md-5">
              <input type="text" class="form-control" name="languages[${languageCount}].name" placeholder="Nom de la langue">
            </div>
            <div class="col-md-5">
              <select class="form-select" name="languages[${languageCount}].proficiency">
                <option value="">Niveau de maîtrise</option>
                <option value="Débutant">Débutant</option>
                <option value="Intermédiaire">Intermédiaire</option>
                <option value="Avancé">Avancé</option>
                <option value="Bilingue">Bilingue</option>
                <option value="Langue maternelle">Langue maternelle</option>
              </select>
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-outline-danger remove-language">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;

          languagesContainer.appendChild(newLanguageRow);

          // Activer le bouton de suppression
          if (languagesContainer.querySelectorAll('.language-row').length > 1) {
            languagesContainer.querySelectorAll('.remove-language').forEach(btn => {
              btn.classList.remove('d-none');
            });
          }

          // Ajouter l'écouteur d'événement pour la suppression
          newLanguageRow.querySelector('.remove-language').addEventListener('click', function() {
            newLanguageRow.remove();
            reindexLanguages();

            // Masquer le bouton de suppression s'il ne reste qu'une langue
            if (languagesContainer.querySelectorAll('.language-row').length <= 1) {
              languagesContainer.querySelector('.remove-language').classList.add('d-none');
            }
          });
        });
      }

      // Reindex skills to maintain correct array indexes
      function reindexSkills() {
        const skillsContainer = document.getElementById('skillsContainer');
        const skillRows = skillsContainer.querySelectorAll('.skill-row');

        skillRows.forEach((row, index) => {
          const nameInput = row.querySelector('input[name^="skills["]');
          const proficiencySelect = row.querySelector('select[name^="skills["]');

          if (nameInput) {
            nameInput.name = `skills[${index}].name`;
          }
          if (proficiencySelect) {
            proficiencySelect.name = `skills[${index}].proficiency`;
          }
        });
      }

      // Reindex languages to maintain correct array indexes
      function reindexLanguages() {
        const languagesContainer = document.getElementById('languagesContainer');
        const languageRows = languagesContainer.querySelectorAll('.language-row');

        languageRows.forEach((row, index) => {
          const nameInput = row.querySelector('input[name^="languages["]');
          const proficiencySelect = row.querySelector('select[name^="languages["]');

          if (nameInput) {
            nameInput.name = `languages[${index}].name`;
          }
          if (proficiencySelect) {
            proficiencySelect.name = `languages[${index}].proficiency`;
          }
        });
      }

      // Submit add candidat form
      if (addCandidatSubmit) {
        addCandidatSubmit.addEventListener('click', function() {
          if (!addCandidatForm.checkValidity()) {
            addCandidatForm.classList.add('was-validated');
            return;
          }

          // Collect form data
          const formData = new FormData(addCandidatForm);
          const candidatData = {};

          // Convert FormData to object with proper structure
          const skills = [];
          const languages = [];
          const basicInfo = {};

          formData.forEach((value, key) => {
            if (key.startsWith('skills[')) {
              const match = key.match(/skills\[(\d+)\]\.(\w+)/);
              if (match) {
                const index = parseInt(match[1]);
                const property = match[2];

                if (!skills[index]) {
                  skills[index] = {};
                }
                skills[index][property] = value;
              }
            } else if (key.startsWith('languages[')) {
              const match = key.match(/languages\[(\d+)\]\.(\w+)/);
              if (match) {
                const index = parseInt(match[1]);
                const property = match[2];

                if (!languages[index]) {
                  languages[index] = {};
                }

                languages[index][property] = value;

                // Add proficiencyLevel for languages
                if (property === 'proficiency') {
                  const level = getProficiencyLevel(value);
                  languages[index]['proficiencyLevel'] = level;
                }
              }
            } else {
              basicInfo[key] = value;
            }
          });

          // Filter out empty skills and languages
          const filteredSkills = skills.filter(skill => skill && skill.name && skill.name.trim() !== '');
          const filteredLanguages = languages.filter(lang => lang && lang.name && lang.name.trim() !== '');

          // Combine all data
          candidatData.skills = filteredSkills;
          candidatData.languages = filteredLanguages;
          Object.assign(candidatData, basicInfo);

          // Send data to server
          fetch('/admin/candidats/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(candidatData)
          })
                  .then(response => response.json())
                  .then(data => {
                    if (data.success) {
                      // Reset form and close modal
                      addCandidatForm.reset();
                      addCandidatForm.classList.remove('was-validated');
                      addCandidatModal.hide();

                      // Reload page to show new candidat
                      window.location.reload();
                    } else {
                      alert('Erreur lors de l\'ajout du candidat: ' + data.error);
                    }
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    alert('Une erreur est survenue lors de l\'ajout du candidat');
                  });
        });
      }

      // Edit candidat
      const editButtons = document.querySelectorAll('.edit-candidat');
      const editCandidatForm = document.getElementById('editCandidatForm');
      const editCandidatSubmit = document.getElementById('editCandidatSubmit');

      // Helper for edit - add skill row
      function addEditSkillRow(container, skill, index) {
        const newRow = document.createElement('div');
        newRow.className = 'row mb-2 edit-skill-row';
        newRow.innerHTML = `
          <div class="col-md-5">
            <input type="text" class="form-control" name="skills[${index}].name" value="${skill ? skill.name : ''}" placeholder="Nom de la compétence">
            <input type="hidden" name="skills[${index}].id" value="${skill ? skill.id || '' : ''}">
          </div>
          <div class="col-md-5">
            <select class="form-select" name="skills[${index}].proficiency">
              <option value="">Niveau de maîtrise</option>
              <option value="Débutant" ${skill && skill.proficiency === 'Débutant' ? 'selected' : ''}>Débutant</option>
              <option value="Intermédiaire" ${skill && skill.proficiency === 'Intermédiaire' ? 'selected' : ''}>Intermédiaire</option>
              <option value="Avancé" ${skill && skill.proficiency === 'Avancé' ? 'selected' : ''}>Avancé</option>
              <option value="Expert" ${skill && skill.proficiency === 'Expert' ? 'selected' : ''}>Expert</option>
            </select>
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-outline-danger edit-remove-skill">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;

        container.appendChild(newRow);

        // Ajouter l'écouteur d'événement pour la suppression
        newRow.querySelector('.edit-remove-skill').addEventListener('click', function() {
          newRow.remove();
          reindexEditSkills();

          // Masquer le bouton de suppression s'il ne reste qu'une compétence
          if (container.querySelectorAll('.edit-skill-row').length <= 1) {
            const lastRemoveBtn = container.querySelector('.edit-remove-skill');
            if (lastRemoveBtn) {
              lastRemoveBtn.classList.add('d-none');
            }
          }
        });

        // Afficher/masquer les boutons de suppression
        const removeButtons = container.querySelectorAll('.edit-remove-skill');
        removeButtons.forEach(btn => {
          btn.classList.toggle('d-none', container.querySelectorAll('.edit-skill-row').length <= 1);
        });
      }

      // Helper for edit - add language row
      function addEditLanguageRow(container, language, index) {
        const newRow = document.createElement('div');
        newRow.className = 'row mb-2 edit-language-row';
        newRow.innerHTML = `
          <div class="col-md-5">
            <input type="text" class="form-control" name="languages[${index}].name" value="${language ? language.name : ''}" placeholder="Nom de la langue">
            <input type="hidden" name="languages[${index}].id" value="${language ? language.id || '' : ''}">
          </div>
          <div class="col-md-5">
            <select class="form-select" name="languages[${index}].proficiency">
              <option value="">Niveau de maîtrise</option>
              <option value="Débutant" ${language && language.proficiency === 'Débutant' ? 'selected' : ''}>Débutant</option>
              <option value="Intermédiaire" ${language && language.proficiency === 'Intermédiaire' ? 'selected' : ''}>Intermédiaire</option>
              <option value="Avancé" ${language && language.proficiency === 'Avancé' ? 'selected' : ''}>Avancé</option>
              <option value="Bilingue" ${language && language.proficiency === 'Bilingue' ? 'selected' : ''}>Bilingue</option>
              <option value="Langue maternelle" ${language && language.proficiency === 'Langue maternelle' ? 'selected' : ''}>Langue maternelle</option>
            </select>
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-outline-danger edit-remove-language">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;

        container.appendChild(newRow);

        // Ajouter l'écouteur d'événement pour la suppression
        newRow.querySelector('.edit-remove-language').addEventListener('click', function() {
          newRow.remove();
          reindexEditLanguages();

          // Masquer le bouton de suppression s'il ne reste qu'une langue
          if (container.querySelectorAll('.edit-language-row').length <= 1) {
            const lastRemoveBtn = container.querySelector('.edit-remove-language');
            if (lastRemoveBtn) {
              lastRemoveBtn.classList.add('d-none');
            }
          }
        });

        // Afficher/masquer les boutons de suppression
        const removeButtons = container.querySelectorAll('.edit-remove-language');
        removeButtons.forEach(btn => {
          btn.classList.toggle('d-none', container.querySelectorAll('.edit-language-row').length <= 1);
        });
      }

      // Load candidat data when edit button is clicked
      editButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          const candidatId = this.getAttribute('data-id');

          // Fetch candidat data
          fetch(`/admin/candidats/${candidatId}/data`)
                  .then(response => response.json())
                  .then(candidat => {
                    // Populate form with candidat data
                    document.getElementById('editCandidatId').value = candidat.id;
                    document.getElementById('editFirstName').value = candidat.firstName || '';
                    document.getElementById('editLastName').value = candidat.lastName || '';
                    document.getElementById('editEmail').value = candidat.email || '';
                    document.getElementById('editPhone').value = candidat.phone || '';

                    // Format date properly YYYY-MM-DD
                    if (candidat.birthdate) {
                      const birthdate = new Date(candidat.birthdate);
                      const year = birthdate.getFullYear();
                      const month = String(birthdate.getMonth() + 1).padStart(2, '0');
                      const day = String(birthdate.getDate()).padStart(2, '0');
                      document.getElementById('editBirthdate').value = `${year}-${month}-${day}`;
                    } else {
                      document.getElementById('editBirthdate').value = '';
                    }

                    document.getElementById('editAddress').value = candidat.address || '';
                    document.getElementById('editSummary').value = candidat.summary || '';

                    // Clear and populate skills
                    const skillsContainer = document.getElementById('editSkillsContainer');
                    skillsContainer.innerHTML = '';

                    if (candidat.skills && candidat.skills.length > 0) {
                      candidat.skills.forEach((skill, index) => {
                        addEditSkillRow(skillsContainer, skill, index);
                      });
                    } else {
                      // Add at least one empty skill row
                      addEditSkillRow(skillsContainer, null, 0);
                    }

                    // Clear and populate languages
                    const languagesContainer = document.getElementById('editLanguagesContainer');
                    languagesContainer.innerHTML = '';

                    if (candidat.languages && candidat.languages.length > 0) {
                      candidat.languages.forEach((language, index) => {
                        addEditLanguageRow(languagesContainer, language, index);
                      });
                    } else {
                      // Add at least one empty language row
                      addEditLanguageRow(languagesContainer, null, 0);
                    }

                    // Setup add buttons
                    const editAddSkillBtn = document.getElementById('editAddSkillBtn');
                    if (editAddSkillBtn) {
                      editAddSkillBtn.addEventListener('click', function() {
                        const skillsContainer = document.getElementById('editSkillsContainer');
                        const skillCount = skillsContainer.querySelectorAll('.edit-skill-row').length;
                        addEditSkillRow(skillsContainer, null, skillCount);
                        reindexEditSkills();
                      });
                    }

                    const editAddLanguageBtn = document.getElementById('editAddLanguageBtn');
                    if (editAddLanguageBtn) {
                      editAddLanguageBtn.addEventListener('click', function() {
                        const languagesContainer = document.getElementById('editLanguagesContainer');
                        const languageCount = languagesContainer.querySelectorAll('.edit-language-row').length;
                        addEditLanguageRow(languagesContainer, null, languageCount);
                        reindexEditLanguages();
                      });
                    }

                    // Show modal
                    editCandidatModal.show();
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    alert('Erreur lors de la récupération des données du candidat');
                  });
        });
      });

      // Reindex edit skills/languages
      function reindexEditSkills() {
        const skillsContainer = document.getElementById('editSkillsContainer');
        const skillRows = skillsContainer.querySelectorAll('.edit-skill-row');

        skillRows.forEach((row, index) => {
          const nameInput = row.querySelector('input[name^="skills["][name$="].name"]');
          const idInput = row.querySelector('input[name^="skills["][name$="].id"]');
          const proficiencySelect = row.querySelector('select[name^="skills["]');

          if (nameInput) {
            nameInput.name = `skills[${index}].name`;
          }
          if (idInput) {
            idInput.name = `skills[${index}].id`;
          }
          if (proficiencySelect) {
            proficiencySelect.name = `skills[${index}].proficiency`;
          }
        });
      }

      function reindexEditLanguages() {
        const languagesContainer = document.getElementById('editLanguagesContainer');
        const languageRows = languagesContainer.querySelectorAll('.edit-language-row');

        languageRows.forEach((row, index) => {
          const nameInput = row.querySelector('input[name^="languages["][name$="].name"]');
          const idInput = row.querySelector('input[name^="languages["][name$="].id"]');
          const proficiencySelect = row.querySelector('select[name^="languages["]');

          if (nameInput) {
            nameInput.name = `languages[${index}].name`;
          }
          if (idInput) {
            idInput.name = `languages[${index}].id`;
          }
          if (proficiencySelect) {
            proficiencySelect.name = `languages[${index}].proficiency`;
          }
        });
      }

      // Helper function to get proficiency level from string
      function getProficiencyLevel(proficiency) {
        switch (proficiency) {
          case 'Débutant': return 20;
          case 'Intermédiaire': return 40;
          case 'Avancé': return 60;
          case 'Bilingue': return 80;
          case 'Langue maternelle': return 95;
          case 'Expert': return 90;
          default: return 0;
        }
      }

      // Submit edit candidat form
      if (editCandidatSubmit) {
        editCandidatSubmit.addEventListener('click', function() {
          if (!editCandidatForm.checkValidity()) {
            editCandidatForm.classList.add('was-validated');
            return;
          }

          // Collect form data
          const formData = new FormData(editCandidatForm);
          const candidatData = {};

          // Convert FormData to object with proper structure
          const skills = [];
          const languages = [];
          const basicInfo = {};

          formData.forEach((value, key) => {
            if (key.startsWith('skills[')) {
              const match = key.match(/skills\[(\d+)\]\.(\w+)/);
              if (match) {
                const index = parseInt(match[1]);
                const property = match[2];

                if (!skills[index]) {
                  skills[index] = {};
                }
                skills[index][property] = value;
              }
            } else if (key.startsWith('languages[')) {
              const match = key.match(/languages\[(\d+)\]\.(\w+)/);
              if (match) {
                const index = parseInt(match[1]);
                const property = match[2];

                if (!languages[index]) {
                  languages[index] = {};
                }

                languages[index][property] = value;

                // Add proficiencyLevel for languages
                if (property === 'proficiency') {
                  const level = getProficiencyLevel(value);
                  languages[index]['proficiencyLevel'] = level;
                }
              }
            } else {
              basicInfo[key] = value;
            }
          });

          // Filter out empty skills and languages
          const filteredSkills = skills.filter(skill => skill && skill.name && skill.name.trim() !== '');
          const filteredLanguages = languages.filter(lang => lang && lang.name && lang.name.trim() !== '');

          // Combine all data
          candidatData.skills = filteredSkills;
          candidatData.languages = filteredLanguages;
          Object.assign(candidatData, basicInfo);

          const candidatId = document.getElementById('editCandidatId').value;

          // Send data to server
          fetch(`/admin/candidats/${candidatId}/update`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(candidatData)
          })
                  .then(response => response.json())
                  .then(data => {
                    if (data.success) {
                      // Reset form and close modal
                      editCandidatForm.classList.remove('was-validated');
                      editCandidatModal.hide();

                      // Reload page to show updated candidat
                      window.location.reload();
                    } else {
                      alert('Erreur lors de la modification du candidat: ' + data.error);
                    }
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    alert('Une erreur est survenue lors de la modification du candidat');
                  });
        });
      }

      // Toggle status functionality
      const statusButtons = document.querySelectorAll('.toggle-status');
      const statusCandidatIdInput = document.getElementById('statusCandidatId');
      const confirmStatusChangeButton = document.getElementById('confirmStatusChange');

      statusButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          const candidatId = this.getAttribute('data-id');
          statusCandidatIdInput.value = candidatId;
          statusChangeModal.show();
        });
      });

      if (confirmStatusChangeButton) {
        confirmStatusChangeButton.addEventListener('click', function() {
          const candidatId = statusCandidatIdInput.value;
          const newStatus = document.getElementById('statusSelect').value;

          fetch(`/admin/candidats/${candidatId}/toggle-status`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
          })
                  .then(response => response.json())
                  .then(data => {
                    if (data.success) {
                      window.location.reload();
                    } else {
                      alert('Erreur lors de la mise à jour du statut: ' + data.error);
                    }
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    alert('Une erreur est survenue lors de la mise à jour du statut');
                  });

          statusChangeModal.hide();
        });
      }

      // Export Candidats as CSV
      if (exportBtn) {
        exportBtn.addEventListener('click', function() {
          // Get current filter parameters
          const params = new URLSearchParams(window.location.search);
          // Create export URL with same filters
          const exportUrl = `/admin/candidats/export?${params.toString()}`;
          // Trigger download
          window.location.href = exportUrl;
        });
      }
    });
  </script>
</div>